<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>Villa Pricing Demo | Admin + Front</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
    .input-base {
      @apply w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-400 focus:border-sky-400;
    }
  </style>
</head>
<body class="bg-slate-100 min-h-screen">

  <!-- Top bar -->
  <header class="bg-white shadow-sm sticky top-0 z-10">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="font-semibold text-slate-800">
        üè° Villa Pricing System (Demo)
      </div>
      <div class="flex gap-2 text-sm">
        <button id="btnAdminTab"
                class="px-3 py-1.5 rounded-full bg-sky-600 text-white font-medium">
          ‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô (Admin)
        </button>
        <button id="btnFrontTab"
                class="px-3 py-1.5 rounded-full bg-slate-200 text-slate-700 font-medium">
          ‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡πâ‡∏≤‡∏ô (‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤)
        </button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6 space-y-6">

    <!-- ADMIN SECTION -->
    <section id="adminSection" class="space-y-6">
      <h1 class="text-xl font-semibold text-slate-800">
        ‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô: ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏ó‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ö‡πâ‡∏≤‡∏ô‡∏û‡∏±‡∏Å & ‡πÅ‡∏û‡πá‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô
      </h1>

      <!-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡πâ‡∏≤‡∏ô -->
      <div class="bg-white rounded-2xl shadow-sm p-4 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div class="space-y-1">
          <div class="text-sm font-medium text-slate-700">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡πâ‡∏≤‡∏ô‡∏û‡∏±‡∏Å</div>
          <select id="adminVillaSelect"
                  class="border border-slate-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-400 focus:border-sky-400">
          </select>
        </div>
        <div class="space-y-1">
          <div class="text-sm font-medium text-slate-700">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏£‡∏ó‡∏£‡∏≤‡∏Ñ‡∏≤</div>
          <select id="adminRateSelect"
                  class="border border-slate-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-400 focus:border-sky-400">
          </select>
        </div>
        <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏£‡∏ó‡πÉ‡∏´‡∏°‡πà (demo: ‡πÅ‡∏Ñ‡πà clone logic) -->
        <button id="btnCloneRate"
                class="self-start md:self-end px-4 py-2 text-sm rounded-xl bg-emerald-500 text-white font-medium hover:bg-emerald-600">
          ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÄ‡∏£‡∏ó‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏£‡∏ó‡πÉ‡∏´‡∏°‡πà (Demo)
        </button>
      </div>

      <!-- ‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏£‡∏ó‡∏£‡∏≤‡∏Ñ‡∏≤ -->
      <div class="bg-white rounded-2xl shadow-sm p-5 space-y-6">
        <h2 class="text-lg font-semibold text-slate-800 mb-2">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏£‡∏ó‡∏£‡∏≤‡∏Ñ‡∏≤</h2>

        <div class="grid md:grid-cols-2 gap-4">
          <!-- ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏ó -->
          <div class="space-y-1">
            <label class="text-sm font-medium text-slate-700">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏ó</label>
            <input id="rateNameInput" type="text"
                   class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-400 focus:border-sky-400" />
          </div>

          <!-- ‡πÇ‡∏´‡∏°‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤ -->
          <div class="space-y-1">
            <label class="text-sm font-medium text-slate-700">‡∏ß‡∏¥‡∏ò‡∏µ‡∏Ñ‡∏¥‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤</label>
            <select id="pricingModeSelect"
                    class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-400 focus:border-sky-400">
              <option value="TIER_PLUS_EXTRA">‡πÅ‡∏û‡πá‡∏Å + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏´‡∏±‡∏ß (TIER_PLUS_EXTRA)</option>
              <option value="TIER_ONLY">‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏û‡πá‡∏Å‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏Ñ‡∏ô (TIER_ONLY)</option>
            </select>
            <p class="text-xs text-slate-500">
              TIER_PLUS_EXTRA: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏û‡πá‡∏Å‡∏ó‡∏µ‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏¥‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏≤‡∏°‡∏´‡∏±‡∏ß‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏à‡∏≤‡∏Å‡πÅ‡∏û‡πá‡∏Å
            </p>
          </div>

          <!-- Extra per guest -->
          <div class="space-y-1">
            <label class="text-sm font-medium text-slate-700">‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡πà‡∏≠‡∏Ñ‡∏ô‡∏à‡∏≤‡∏Å‡πÅ‡∏û‡πá‡∏Å (‡∏ö‡∏≤‡∏ó/‡∏Ñ‡∏ô)</label>
            <input id="extraPerGuestInput" type="number" min="0" step="10"
                   class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-400 focus:border-sky-400" />
          </div>

          <!-- Active toggle -->
          <div class="space-y-1">
            <label class="text-sm font-medium text-slate-700">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏£‡∏ó</label>
            <div class="flex items-center gap-2">
              <input id="rateActiveCheckbox" type="checkbox" class="h-4 w-4">
              <span class="text-sm text-slate-700">‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏ó‡∏ô‡∏µ‡πâ</span>
            </div>
          </div>
        </div>

        <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á Tier -->
        <div class="mt-4 border-t pt-4 space-y-3">
          <div class="flex items-center justify-between gap-2">
            <h3 class="text-sm font-semibold text-slate-800">‡πÅ‡∏û‡πá‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô + ‡∏£‡∏≤‡∏Ñ‡∏≤ (Tier)</h3>
            <button id="btnAddTier"
                    class="px-3 py-1.5 rounded-lg bg-sky-500 text-white text-xs font-medium hover:bg-sky-600">
              + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏û‡πá‡∏Å
            </button>
          </div>

          <div class="overflow-x-auto">
            <table class="min-w-full text-sm text-left border border-slate-200 rounded-lg overflow-hidden">
              <thead class="bg-slate-50 text-slate-600">
                <tr>
                  <th class="px-3 py-2 border-b border-slate-200">#</th>
                  <th class="px-3 py-2 border-b border-slate-200">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô‡πÉ‡∏ô‡πÅ‡∏û‡πá‡∏Å</th>
                  <th class="px-3 py-2 border-b border-slate-200">‡∏£‡∏≤‡∏Ñ‡∏≤‡πÅ‡∏û‡πá‡∏Å (‡∏ö‡∏≤‡∏ó/‡∏Ñ‡∏∑‡∏ô)</th>
                  <th class="px-3 py-2 border-b border-slate-200">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</th>
                  <th class="px-3 py-2 border-b border-slate-200 text-right">‡∏•‡∏ö</th>
                </tr>
              </thead>
              <tbody id="tierTableBody" class="divide-y divide-slate-100 bg-white"></tbody>
            </table>
          </div>
        </div>

        <!-- ‡πÅ‡∏ñ‡∏ß‡∏õ‡∏∏‡πà‡∏° & preview -->
        <div class="mt-4 grid md:grid-cols-2 gap-6 items-start">
          <!-- Save (‡πÅ‡∏Ñ‡πà update state ‡πÉ‡∏ô JS) -->
          <div class="space-y-3">
            <button id="btnSaveRate"
                    class="w-full md:w-auto px-4 py-2 rounded-xl bg-emerald-500 text-white text-sm font-medium hover:bg-emerald-600">
              üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏ó (‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Demo)
            </button>
            <p class="text-xs text-slate-500">
              *‡πÉ‡∏ô Demo ‡∏ô‡∏µ‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ JavaScript ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á
            </p>
          </div>

          <!-- Preview ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤ -->
          <div class="border border-slate-200 rounded-xl p-3 bg-slate-50 space-y-2">
            <div class="text-sm font-semibold text-slate-800">üîç ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤</div>
            <div class="flex flex-wrap gap-3 items-end">
              <div>
                <label class="block text-xs text-slate-600 mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô</label>
                <input id="previewGuestInput" type="number" min="1" value="8"
                       class="w-24 border border-slate-300 rounded-lg px-2 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-sky-400 focus:border-sky-400">
              </div>
              <div>
                <label class="block text-xs text-slate-600 mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏∑‡∏ô</label>
                <input id="previewNightInput" type="number" min="1" value="1"
                       class="w-24 border border-slate-300 rounded-lg px-2 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-sky-400 focus:border-sky-400">
              </div>
              <button id="btnPreviewPrice"
                      class="px-3 py-1.5 rounded-lg bg-sky-500 text-white text-xs font-medium hover:bg-sky-600">
                ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì
              </button>
            </div>
            <div id="previewPriceResult" class="text-xs text-slate-700 mt-2 whitespace-pre-line">
              (‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà)
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- FRONT SECTION -->
    <section id="frontSection" class="hidden space-y-6">
      <h1 class="text-xl font-semibold text-slate-800">
        ‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡πâ‡∏≤‡∏ô: ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô & ‡∏î‡∏π‡∏£‡∏≤‡∏Ñ‡∏≤
      </h1>

      <div class="bg-white rounded-2xl shadow-sm p-5 space-y-5">
        <!-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡πâ‡∏≤‡∏ô -->
        <div class="grid md:grid-cols-3 gap-4">
          <div class="space-y-1">
            <label class="text-sm font-medium text-slate-700">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡πâ‡∏≤‡∏ô‡∏û‡∏±‡∏Å</label>
            <select id="frontVillaSelect"
                    class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-400 focus:border-sky-400">
            </select>
          </div>
          <div class="space-y-1">
            <label class="text-sm font-medium text-slate-700">‡∏ß‡∏±‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô (Demo)</label>
            <input id="frontCheckInInput" type="date"
                   class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-400 focus:border-sky-400">
          </div>
          <div class="space-y-1">
            <label class="text-sm font-medium text-slate-700">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏∑‡∏ô</label>
            <input id="frontNightInput" type="number" min="1" value="1"
                   class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-400 focus:border-sky-400">
          </div>
        </div>

        <!-- ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô -->
        <div class="flex flex-wrap items-end gap-4 mt-2">
          <div class="space-y-1">
            <label class="text-sm font-medium text-slate-700">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å</label>
            <div class="flex items-center border border-slate-300 rounded-lg overflow-hidden">
              <button id="btnGuestMinus"
                      class="px-3 py-2 text-slate-600 hover:bg-slate-100 text-lg">‚àí</button>
              <input id="frontGuestInput" type="number" min="1" value="8"
                     class="w-20 text-center border-x border-slate-200 py-2 text-sm focus:outline-none">
              <button id="btnGuestPlus"
                      class="px-3 py-2 text-slate-600 hover:bg-slate-100 text-lg">+</button>
            </div>
          </div>
          <button id="btnFrontCalc"
                  class="px-4 py-2 rounded-xl bg-sky-600 text-white text-sm font-medium hover:bg-sky-700">
            ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤
          </button>
        </div>

        <!-- ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤ -->
        <div id="frontPriceBox" class="mt-5 border border-slate-200 rounded-2xl p-4 bg-slate-50 hidden">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
            <div>
              <div id="frontPriceTitle" class="text-sm font-semibold text-slate-800">
                ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö X ‡∏Ñ‡∏ô / Y ‡∏Ñ‡∏∑‡∏ô
              </div>
              <div id="frontPriceMain" class="text-2xl font-bold text-emerald-600 mt-1">
                0 ‡∏ö‡∏≤‡∏ó
              </div>
            </div>
            <div class="text-xs text-slate-500">
              ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô<br>
              ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏∞‡∏Ñ‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÄ‡∏£‡∏ó‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô ‡∏ì ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏á
            </div>
          </div>

          <div id="frontPriceDetails" class="mt-3 text-sm text-slate-700 whitespace-pre-line">
          </div>

          <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡πá‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î -->
          <div id="frontTierList" class="mt-4 border-t border-slate-200 pt-3 text-xs text-slate-700">
          </div>

          <div class="mt-4 flex justify-end">
            <button class="px-4 py-2 rounded-xl bg-emerald-500 text-white text-sm font-medium hover:bg-emerald-600">
              ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ï‡πà‡∏≠ (Demo)
            </button>
          </div>
        </div>
      </div>
    </section>

  </main>

  <script>
    // -----------------------------
    // Mock Data (‡πÅ‡∏ó‡∏ô DB)
    // -----------------------------
    const villas = [
      {
        id: 'villa1',
        code: 'VILLA-A1',
        name: 'Lumina Poolvilla Sunset',
        maxGuests: 20
      },
      {
        id: 'villa2',
        code: 'VILLA-B1',
        name: 'Ocean Breeze Villa Blue',
        maxGuests: 16
      }
    ];

    // rates: ‡∏ú‡∏π‡∏Å‡∏Å‡∏±‡∏ö villaId + tiers
    let villaRates = [
      {
        id: 'rate1',
        villaId: 'villa1',
        rateName: 'Default Rate',
        pricingMode: 'TIER_PLUS_EXTRA',
        extraPerGuest: 300,
        isActive: true,
        tiers: [
          { includedGuest: 7, basePrice: 3990 },
          { includedGuest: 10, basePrice: 4990 },
          { includedGuest: 16, basePrice: 6990 }
        ]
      },
      {
        id: 'rate2',
        villaId: 'villa2',
        rateName: 'Default Rate',
        pricingMode: 'TIER_ONLY',
        extraPerGuest: 0,
        isActive: true,
        tiers: [
          { includedGuest: 4, basePrice: 3500 },
          { includedGuest: 8, basePrice: 5500 },
          { includedGuest: 12, basePrice: 7500 }
        ]
      }
    ];

    // -----------------------------
    // Helper: format number with comma
    // -----------------------------
    function formatBaht(num) {
      return num.toLocaleString('th-TH', { maximumFractionDigits: 0 });
    }

    // -----------------------------
    // Helper: calculate price
    // -----------------------------
    function calcPriceForGuests(villaId, guestCount, nights) {
      const relevantRates = villaRates.filter(r => r.villaId === villaId && r.isActive);
      if (!relevantRates.length) return null;

      const rate = relevantRates[0]; // demo: ‡πÉ‡∏ä‡πâ‡πÄ‡∏£‡∏ó‡πÅ‡∏£‡∏Å
      if (!rate.tiers || !rate.tiers.length) return null;

      // sort tiers by includedGuest asc
      const tiers = [...rate.tiers].sort((a, b) => a.includedGuest - b.includedGuest);

      // ‡∏´‡∏≤‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà "‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô guestCount"
      let chosenTier = null;
      for (const t of tiers) {
        if (t.includedGuest <= guestCount) chosenTier = t;
      }
      // ‡∏ñ‡πâ‡∏≤‡∏ó‡∏∏‡∏Å tier ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ guestCount ‚Üí ‡πÉ‡∏ä‡πâ tier ‡πÅ‡∏£‡∏Å‡∏™‡∏∏‡∏î
      if (!chosenTier) chosenTier = tiers[0];

      let baseGuests = chosenTier.includedGuest;
      let basePricePerNight = chosenTier.basePrice;
      let extraGuests = 0;
      let extraPerGuest = 0;
      let extraPricePerNight = 0;

      if (rate.pricingMode === 'TIER_PLUS_EXTRA') {
        extraPerGuest = rate.extraPerGuest || 0;
        extraGuests = Math.max(guestCount - baseGuests, 0);
        extraPricePerNight = extraGuests * extraPerGuest;
      } else {
        // TIER_ONLY: ‡∏ñ‡πâ‡∏≤ guest > max tier ‡∏Å‡πá‡πÉ‡∏ä‡πâ tier ‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏ç‡πà‡∏™‡∏∏‡∏î‡πÑ‡∏õ‡πÄ‡∏•‡∏¢
        if (guestCount > baseGuests) baseGuests = chosenTier.includedGuest;
        extraGuests = 0;
        extraPricePerNight = 0;
      }

      const perNight = basePricePerNight + extraPricePerNight;
      const total = perNight * nights;

      return {
        rate,
        tiers,
        guestCount,
        nights,
        baseTier: chosenTier,
        baseGuests,
        basePricePerNight,
        extraGuests,
        extraPerGuest,
        extraPricePerNight,
        perNight,
        total
      };
    }

    // -----------------------------
    // DOM Elements
    // -----------------------------
    const adminSection = document.getElementById('adminSection');
    const frontSection = document.getElementById('frontSection');
    const btnAdminTab = document.getElementById('btnAdminTab');
    const btnFrontTab = document.getElementById('btnFrontTab');

    const adminVillaSelect = document.getElementById('adminVillaSelect');
    const adminRateSelect = document.getElementById('adminRateSelect');
    const rateNameInput = document.getElementById('rateNameInput');
    const pricingModeSelect = document.getElementById('pricingModeSelect');
    const extraPerGuestInput = document.getElementById('extraPerGuestInput');
    const rateActiveCheckbox = document.getElementById('rateActiveCheckbox');
    const tierTableBody = document.getElementById('tierTableBody');
    const btnAddTier = document.getElementById('btnAddTier');
    const btnSaveRate = document.getElementById('btnSaveRate');
    const btnCloneRate = document.getElementById('btnCloneRate');

    const previewGuestInput = document.getElementById('previewGuestInput');
    const previewNightInput = document.getElementById('previewNightInput');
    const btnPreviewPrice = document.getElementById('btnPreviewPrice');
    const previewPriceResult = document.getElementById('previewPriceResult');

    const frontVillaSelect = document.getElementById('frontVillaSelect');
    const frontCheckInInput = document.getElementById('frontCheckInInput');
    const frontNightInput = document.getElementById('frontNightInput');
    const frontGuestInput = document.getElementById('frontGuestInput');
    const btnGuestMinus = document.getElementById('btnGuestMinus');
    const btnGuestPlus = document.getElementById('btnGuestPlus');
    const btnFrontCalc = document.getElementById('btnFrontCalc');

    const frontPriceBox = document.getElementById('frontPriceBox');
    const frontPriceTitle = document.getElementById('frontPriceTitle');
    const frontPriceMain = document.getElementById('frontPriceMain');
    const frontPriceDetails = document.getElementById('frontPriceDetails');
    const frontTierList = document.getElementById('frontTierList');

    // -----------------------------
    // Tab switching
    // -----------------------------
    btnAdminTab.addEventListener('click', () => {
      adminSection.classList.remove('hidden');
      frontSection.classList.add('hidden');
      btnAdminTab.classList.remove('bg-slate-200','text-slate-700');
      btnAdminTab.classList.add('bg-sky-600','text-white');
      btnFrontTab.classList.remove('bg-sky-600','text-white');
      btnFrontTab.classList.add('bg-slate-200','text-slate-700');
    });

    btnFrontTab.addEventListener('click', () => {
      adminSection.classList.add('hidden');
      frontSection.classList.remove('hidden');
      btnFrontTab.classList.remove('bg-slate-200','text-slate-700');
      btnFrontTab.classList.add('bg-sky-600','text-white');
      btnAdminTab.classList.remove('bg-sky-600','text-white');
      btnAdminTab.classList.add('bg-slate-200','text-slate-700');
    });

    // -----------------------------
    // Init selects
    // -----------------------------
    function populateVillaSelects() {
      adminVillaSelect.innerHTML = '';
      frontVillaSelect.innerHTML = '';
      villas.forEach(v => {
        const opt1 = document.createElement('option');
        opt1.value = v.id;
        opt1.textContent = v.name;
        adminVillaSelect.appendChild(opt1);

        const opt2 = document.createElement('option');
        opt2.value = v.id;
        opt2.textContent = v.name;
        frontVillaSelect.appendChild(opt2);
      });
    }

    function populateRateSelectForAdmin() {
      const villaId = adminVillaSelect.value;
      const rates = villaRates.filter(r => r.villaId === villaId);
      adminRateSelect.innerHTML = '';
      rates.forEach(r => {
        const opt = document.createElement('option');
        opt.value = r.id;
        opt.textContent = r.rateName + (r.isActive ? '' : ' (‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô)');
        adminRateSelect.appendChild(opt);
      });
      if (!rates.length) {
        const opt = document.createElement('option');
        opt.value = '';
        opt.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏£‡∏ó‡∏£‡∏≤‡∏Ñ‡∏≤';
        adminRateSelect.appendChild(opt);
      }
      loadRateToForm();
    }

    function loadRateToForm() {
      const rateId = adminRateSelect.value;
      const rate = villaRates.find(r => r.id === rateId);
      if (!rate) {
        rateNameInput.value = '';
        pricingModeSelect.value = 'TIER_PLUS_EXTRA';
        extraPerGuestInput.value = '';
        rateActiveCheckbox.checked = false;
        tierTableBody.innerHTML = '';
        return;
      }
      rateNameInput.value = rate.rateName;
      pricingModeSelect.value = rate.pricingMode;
      extraPerGuestInput.value = rate.extraPerGuest;
      rateActiveCheckbox.checked = !!rate.isActive;

      // render tiers
      tierTableBody.innerHTML = '';
      const tiers = [...rate.tiers].sort((a, b) => a.includedGuest - b.includedGuest);
      tiers.forEach((t, index) => {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-slate-50';
        tr.innerHTML = `
          <td class="px-3 py-2">${index + 1}</td>
          <td class="px-3 py-2">
            <input type="number" min="1" value="${t.includedGuest}"
                   class="w-24 border border-slate-300 rounded-lg px-2 py-1 text-sm">
          </td>
          <td class="px-3 py-2">
            <input type="number" min="0" step="10" value="${t.basePrice}"
                   class="w-32 border border-slate-300 rounded-lg px-2 py-1 text-sm">
          </td>
          <td class="px-3 py-2 text-xs text-slate-600">
            ‡∏£‡∏ß‡∏°‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î ${t.includedGuest} ‡∏Ñ‡∏ô = ${formatBaht(t.basePrice)} ‡∏ö‡∏≤‡∏ó/‡∏Ñ‡∏∑‡∏ô
          </td>
          <td class="px-3 py-2 text-right">
            <button class="text-xs text-rose-600 hover:text-rose-700">‡∏•‡∏ö</button>
          </td>
        `;
        const delBtn = tr.querySelector('button');
        delBtn.addEventListener('click', () => {
          tr.remove();
        });
        tierTableBody.appendChild(tr);
      });
    }

    // -----------------------------
    // Admin events
    // -----------------------------
    adminVillaSelect.addEventListener('change', populateRateSelectForAdmin);
    adminRateSelect.addEventListener('change', loadRateToForm);

    btnAddTier.addEventListener('click', () => {
      const tr = document.createElement('tr');
      tr.className = 'hover:bg-slate-50';
      tr.innerHTML = `
        <td class="px-3 py-2">#</td>
        <td class="px-3 py-2">
          <input type="number" min="1" value="1"
                 class="w-24 border border-slate-300 rounded-lg px-2 py-1 text-sm">
        </td>
        <td class="px-3 py-2">
          <input type="number" min="0" step="10" value="1000"
                 class="w-32 border border-slate-300 rounded-lg px-2 py-1 text-sm">
        </td>
        <td class="px-3 py-2 text-xs text-slate-600">
          ‡∏£‡∏ß‡∏°‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 1 ‡∏Ñ‡∏ô = 1,000 ‡∏ö‡∏≤‡∏ó/‡∏Ñ‡∏∑‡∏ô
        </td>
        <td class="px-3 py-2 text-right">
          <button class="text-xs text-rose-600 hover:text-rose-700">‡∏•‡∏ö</button>
        </td>
      `;
      tr.querySelector('button').addEventListener('click', () => tr.remove());
      tierTableBody.appendChild(tr);
    });

    btnSaveRate.addEventListener('click', () => {
      const rateId = adminRateSelect.value;
      const rate = villaRates.find(r => r.id === rateId);
      if (!rate) {
        alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏£‡∏ó‡∏£‡∏≤‡∏Ñ‡∏≤‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡πÉ‡∏ô demo ‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏£‡∏ó‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏Å‡πà‡∏≠‡∏ô)');
        return;
      }

      // update header fields
      rate.rateName = rateNameInput.value || 'New Rate';
      rate.pricingMode = pricingModeSelect.value;
      rate.extraPerGuest = parseFloat(extraPerGuestInput.value) || 0;
      rate.isActive = rateActiveCheckbox.checked;

      // update tiers
      const rows = Array.from(tierTableBody.querySelectorAll('tr'));
      const newTiers = [];
      for (const row of rows) {
        const inputs = row.querySelectorAll('input');
        const g = parseInt(inputs[0].value, 10);
        const p = parseFloat(inputs[1].value);
        if (!isNaN(g) && !isNaN(p)) {
          newTiers.push({ includedGuest: g, basePrice: p });
        }
      }
      newTiers.sort((a, b) => a.includedGuest - b.includedGuest);
      rate.tiers = newTiers;

      populateRateSelectForAdmin();
      alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏ó (‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ demo) ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
    });

    btnPreviewPrice.addEventListener('click', () => {
      const villaId = adminVillaSelect.value;
      const guests = parseInt(previewGuestInput.value, 10) || 1;
      const nights = parseInt(previewNightInput.value, 10) || 1;
      const result = calcPriceForGuests(villaId, guests, nights);
      if (!result) {
        previewPriceResult.textContent = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏£‡∏ó‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏û‡πá‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡πâ‡∏≤‡∏ô‡∏ô‡∏µ‡πâ';
        return;
      }
      const {
        baseTier,
        basePricePerNight,
        extraGuests,
        extraPerGuest,
        extraPricePerNight,
        perNight,
        total
      } = result;

      let text = `‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô: ${guests} ‡∏Ñ‡∏ô / ${nights} ‡∏Ñ‡∏∑‡∏ô\n`;
      text += `‡πÅ‡∏û‡πá‡∏Å‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ: ‡πÅ‡∏û‡πá‡∏Å ${baseTier.includedGuest} ‡∏Ñ‡∏ô = ${formatBaht(basePricePerNight)} ‡∏ö‡∏≤‡∏ó/‡∏Ñ‡∏∑‡∏ô\n`;
      if (extraGuests > 0 && extraPerGuest > 0) {
        text += `‡∏Ñ‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡∏à‡∏≤‡∏Å‡πÅ‡∏û‡πá‡∏Å: ${extraGuests} ‡∏Ñ‡∏ô x ${formatBaht(extraPerGuest)} ‡∏ö‡∏≤‡∏ó = ${formatBaht(extraPricePerNight)} ‡∏ö‡∏≤‡∏ó/‡∏Ñ‡∏∑‡∏ô\n`;
      }
      text += `‡∏£‡∏ß‡∏°‡∏ï‡πà‡∏≠‡∏Ñ‡∏∑‡∏ô: ${formatBaht(perNight)} ‡∏ö‡∏≤‡∏ó\n`;
      text += `‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏ó‡∏£‡∏¥‡∏õ: ${formatBaht(total)} ‡∏ö‡∏≤‡∏ó`;
      previewPriceResult.textContent = text;
    });

    btnCloneRate.addEventListener('click', () => {
      const currentRateId = adminRateSelect.value;
      const currentRate = villaRates.find(r => r.id === currentRateId);
      if (!currentRate) {
        alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏£‡∏ó‡πÉ‡∏´‡πâ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å');
        return;
      }
      const newId = 'rate_' + Math.random().toString(36).slice(2, 8);
      const clone = {
        ...currentRate,
        id: newId,
        rateName: currentRate.rateName + ' (Copy)'
      };
      villaRates.push(clone);
      populateRateSelectForAdmin();
      adminRateSelect.value = newId;
      loadRateToForm();
    });

    // -----------------------------
    // Front events
    // -----------------------------
    btnGuestMinus.addEventListener('click', () => {
      let v = parseInt(frontGuestInput.value, 10) || 1;
      v = Math.max(1, v - 1);
      frontGuestInput.value = v;
    });

    btnGuestPlus.addEventListener('click', () => {
      let v = parseInt(frontGuestInput.value, 10) || 1;
      v = v + 1;
      frontGuestInput.value = v;
    });

    btnFrontCalc.addEventListener('click', () => {
      const villaId = frontVillaSelect.value;
      const nights = parseInt(frontNightInput.value, 10) || 1;
      const guests = parseInt(frontGuestInput.value, 10) || 1;
      const result = calcPriceForGuests(villaId, guests, nights);
      if (!result) {
        frontPriceBox.classList.remove('hidden');
        frontPriceTitle.textContent = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏£‡∏ó‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏û‡πá‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡πâ‡∏≤‡∏ô‡∏ô‡∏µ‡πâ';
        frontPriceMain.textContent = '-';
        frontPriceDetails.textContent = '';
        frontTierList.textContent = '';
        return;
      }
      const {
        rate,
        tiers,
        baseTier,
        basePricePerNight,
        extraGuests,
        extraPerGuest,
        extraPricePerNight,
        perNight,
        total
      } = result;

      frontPriceBox.classList.remove('hidden');
      frontPriceTitle.textContent = `‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ${guests} ‡∏Ñ‡∏ô / ${nights} ‡∏Ñ‡∏∑‡∏ô`;
      frontPriceMain.textContent = `${formatBaht(total)} ‡∏ö‡∏≤‡∏ó`;

      let detail = '';
      detail += `‡πÄ‡∏£‡∏ó: ${rate.rateName} (${rate.pricingMode})\n`;
      detail += `‡πÅ‡∏û‡πá‡∏Å‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ: ‡πÅ‡∏û‡πá‡∏Å ${baseTier.includedGuest} ‡∏Ñ‡∏ô = ${formatBaht(basePricePerNight)} ‡∏ö‡∏≤‡∏ó/‡∏Ñ‡∏∑‡∏ô\n`;
      if (extraGuests > 0 && extraPerGuest > 0) {
        detail += `‡∏Ñ‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡∏à‡∏≤‡∏Å‡πÅ‡∏û‡πá‡∏Å: ${extraGuests} ‡∏Ñ‡∏ô x ${formatBaht(extraPerGuest)} ‡∏ö‡∏≤‡∏ó = ${formatBaht(extraPricePerNight)} ‡∏ö‡∏≤‡∏ó/‡∏Ñ‡∏∑‡∏ô\n`;
      }
      detail += `‡∏£‡∏ß‡∏°‡∏ï‡πà‡∏≠‡∏Ñ‡∏∑‡∏ô: ${formatBaht(perNight)} ‡∏ö‡∏≤‡∏ó\n`;
      detail += `‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏∑‡∏ô: ${nights} ‡∏Ñ‡∏∑‡∏ô\n`;
      detail += `‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏ó‡∏£‡∏¥‡∏õ: ${formatBaht(total)} ‡∏ö‡∏≤‡∏ó`;
      frontPriceDetails.textContent = detail;

      // tier list
      let tierText = '‡πÅ‡∏û‡πá‡∏Å‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏ó‡∏ô‡∏µ‡πâ:\n';
      tiers.forEach(t => {
        tierText += `‚Ä¢ ‡πÅ‡∏û‡πá‡∏Å ${t.includedGuest} ‡∏Ñ‡∏ô ‚Äì ${formatBaht(t.basePrice)} ‡∏ö‡∏≤‡∏ó/‡∏Ñ‡∏∑‡∏ô\n`;
      });
      if (rate.pricingMode === 'TIER_PLUS_EXTRA' && rate.extraPerGuest) {
        tierText += `\n‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: ‡πÅ‡∏û‡πá‡∏Å + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏´‡∏±‡∏ß ‡∏Ñ‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡∏à‡∏≤‡∏Å‡πÅ‡∏û‡πá‡∏Å‡∏Ñ‡∏¥‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏° ${formatBaht(rate.extraPerGuest)} ‡∏ö‡∏≤‡∏ó/‡∏Ñ‡∏ô/‡∏Ñ‡∏∑‡∏ô`;
      }
      frontTierList.textContent = tierText;
    });

    // -----------------------------
    // Init
    // -----------------------------
    function init() {
      populateVillaSelects();
      populateRateSelectForAdmin();

      // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ default ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡πâ‡∏≤‡∏ô
      const today = new Date().toISOString().slice(0, 10);
      frontCheckInInput.value = today;

      // default: ‡πÅ‡∏™‡∏î‡∏á admin ‡∏Å‡πà‡∏≠‡∏ô
      adminSection.classList.remove('hidden');
      frontSection.classList.add('hidden');
    }

    init();
  </script>
</body>
</html>
